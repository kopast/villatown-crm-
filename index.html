<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Villa Town CRM | Премиальная недвижимость Астаны</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --gold: #D4AF37;
            --gold-light: #F4E8C1;
            --dark: #0F0F0F;
            --dark-lighter: #1A1A1A;
            --dark-card: #141414;
            --white: #FFFFFF;
            --gray: #888888;
            --success: #22C55E;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark);
            color: var(--white);
            overflow: hidden;
        }
        
        h1, h2, h3, .brand {
            font-family: 'Playfair Display', serif;
        }
        
        /* Auth Screen */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0F0F0F 0%, #1A1A1A 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        .auth-container {
            background: var(--dark-card);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 24px;
            padding: 48px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .auth-logo h1 {
            color: var(--gold);
            font-size: 32px;
            font-weight: 600;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }
        
        .auth-logo p {
            color: var(--gray);
            font-size: 14px;
            letter-spacing: 3px;
            text-transform: uppercase;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            color: var(--gray);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }
        
        .input-group input {
            width: 100%;
            padding: 14px 16px;
            background: var(--dark-lighter);
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-radius: 12px;
            color: var(--white);
            font-size: 15px;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--gold) 0%, #B8941F 100%);
            border: none;
            border-radius: 12px;
            color: var(--dark);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(212, 175, 55, 0.4);
        }
        
        .auth-tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .auth-tab.active {
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--gold);
            color: var(--gold);
        }
        
        /* Main Layout */
        .app-container {
            display: none;
            height: 100vh;
            grid-template-columns: 280px 1fr 400px;
            grid-template-rows: 70px 1fr;
            grid-template-areas: 
                "sidebar header header"
                "sidebar map details";
        }
        
        /* Header */
        .header {
            grid-area: header;
            background: var(--dark-card);
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .brand {
            color: var(--gold);
            font-size: 24px;
            font-weight: 600;
            letter-spacing: 2px;
        }
        
        .search-box {
            position: relative;
            width: 400px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: var(--dark-lighter);
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-radius: 12px;
            color: var(--white);
            font-size: 14px;
        }
        
        .search-box i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--dark-lighter);
            border-radius: 12px;
            cursor: pointer;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--gold) 0%, #B8941F 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }
        
        /* Sidebar */
        .sidebar {
            grid-area: sidebar;
            background: var(--dark-card);
            border-right: 1px solid rgba(212, 175, 55, 0.1);
            padding: 24px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .nav-section {
            margin-bottom: 32px;
        }
        
        .nav-title {
            color: var(--gray);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 4px;
            color: var(--gray);
        }
        
        .nav-item:hover, .nav-item.active {
            background: rgba(212, 175, 55, 0.1);
            color: var(--gold);
        }
        
        .nav-item i {
            width: 20px;
            height: 20px;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: var(--dark-lighter);
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .agents-list {
            flex: 1;
        }
        
        .agent-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
        }
        
        .agent-item:hover {
            background: var(--dark-lighter);
        }
        
        .agent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .agent-info {
            flex: 1;
        }
        
        .agent-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .agent-objects {
            font-size: 12px;
            color: var(--gray);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }
        
        /* Map Container */
        .map-container {
            grid-area: map;
            position: relative;
            background: #0a0a0a;
        }
        
        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .map-controls {
            position: absolute;
            top: 24px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .map-btn {
            width: 44px;
            height: 44px;
            background: var(--dark-card);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            color: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .map-btn:hover {
            background: var(--gold);
            color: var(--dark);
            transform: scale(1.05);
        }
        
        .filter-panel {
            position: absolute;
            bottom: 24px;
            left: 24px;
            right: 24px;
            background: var(--dark-card);
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-radius: 16px;
            padding: 20px;
            z-index: 1000;
            display: flex;
            gap: 16px;
            align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .filter-label {
            font-size: 11px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .filter-select {
            padding: 10px 14px;
            background: var(--dark-lighter);
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-radius: 10px;
            color: var(--white);
            font-size: 13px;
            min-width: 140px;
            cursor: pointer;
        }
        
        .price-range {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .price-input {
            width: 120px;
            padding: 10px 14px;
            background: var(--dark-lighter);
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-radius: 10px;
            color: var(--white);
            font-size: 13px;
        }
        
        /* Details Panel */
        .details-panel {
            grid-area: details;
            background: var(--dark-card);
            border-left: 1px solid rgba(212, 175, 55, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            padding: 24px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .btn-add {
            padding: 10px 20px;
            background: var(--gold);
            border: none;
            border-radius: 10px;
            color: var(--dark);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.3);
        }
        
        .objects-list {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }
        
        .object-card {
            background: var(--dark-lighter);
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .object-card:hover {
            transform: translateY(-4px);
            border-color: rgba(212, 175, 55, 0.3);
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
        }
        
        .object-image {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            position: relative;
            overflow: hidden;
        }
        
        .object-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .object-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 6px 12px;
            background: rgba(15, 15, 15, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .badge-sale { color: var(--success); border: 1px solid rgba(34, 197, 94, 0.3); }
        .badge-rent { color: var(--info); border: 1px solid rgba(59, 130, 246, 0.3); }
        .badge-viewing { color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); }
        .badge-sold { color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
        
        .object-price {
            position: absolute;
            bottom: 12px;
            left: 12px;
            font-size: 20px;
            font-weight: 700;
            color: var(--gold);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .object-info {
            padding: 16px;
        }
        
        .object-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .object-meta {
            display: flex;
            gap: 16px;
            color: var(--gray);
            font-size: 13px;
            margin-bottom: 12px;
        }
        
        .object-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .object-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        
        .object-agent {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .agent-mini {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold) 0%, #B8941F 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .object-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            background: transparent;
            color: var(--gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: rgba(212, 175, 55, 0.1);
            color: var(--gold);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--dark-card);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 24px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.5);
        }
        
        .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid rgba(212, 175, 55, 0.2);
            background: transparent;
            color: var(--gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background: rgba(212, 175, 55, 0.1);
            color: var(--gold);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 32px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            font-size: 12px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }
        
        .form-input, .form-select, .form-textarea {
            padding: 14px 16px;
            background: var(--dark-lighter);
            border: 1px solid rgba(212, 175, 55, 0.1);
            border-radius: 12px;
            color: var(--white);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }
        
        .photo-upload {
            border: 2px dashed rgba(212, 175, 55, 0.3);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .photo-upload:hover {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.05);
        }
        
        .photo-upload i {
            width: 48px;
            height: 48px;
            color: var(--gold);
            margin-bottom: 16px;
        }
        
        .modal-footer {
            padding: 24px 32px;
            border-top: 1px solid rgba(212, 175, 55, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .btn-secondary {
            padding: 12px 24px;
            background: transparent;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 10px;
            color: var(--white);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--gold);
        }
        
        /* Object Detail View */
        .detail-view {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 600px;
            height: 100%;
            background: var(--dark-card);
            border-left: 1px solid rgba(212, 175, 55, 0.2);
            z-index: 1500;
            overflow-y: auto;
            box-shadow: -20px 0 60px rgba(0,0,0,0.5);
            animation: slideIn 0.4s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .detail-header {
            position: relative;
            height: 400px;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            overflow: hidden;
        }
        
        .detail-header img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .detail-header-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 40px;
            background: linear-gradient(transparent, rgba(15,15,15,0.95));
        }
        
        .detail-price {
            font-size: 36px;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 8px;
        }
        
        .detail-title {
            font-size: 28px;
            font-weight: 600;
            line-height: 1.3;
        }
        
        .detail-close {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 44px;
            height: 44px;
            background: rgba(15,15,15,0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 50%;
            color: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .detail-close:hover {
            background: var(--gold);
            color: var(--dark);
            transform: rotate(90deg);
        }
        
        .detail-content {
            padding: 32px;
        }
        
        .detail-section {
            margin-bottom: 32px;
        }
        
        .detail-section-title {
            font-size: 14px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .detail-features {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        
        .feature-item {
            background: var(--dark-lighter);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(212, 175, 55, 0.1);
        }
        
        .feature-icon {
            color: var(--gold);
            margin-bottom: 8px;
        }
        
        .feature-value {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .feature-label {
            font-size: 12px;
            color: var(--gray);
        }
        
        .status-timeline {
            display: flex;
            gap: 16px;
            margin-top: 24px;
        }
        
        .timeline-item {
            flex: 1;
            padding: 16px;
            background: var(--dark-lighter);
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(212, 175, 55, 0.1);
            position: relative;
        }
        
        .timeline-item.active {
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--gold);
        }
        
        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--gray);
            margin: 0 auto 8px;
        }
        
        .timeline-item.active .timeline-dot {
            background: var(--gold);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.2);
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .gallery-item {
            aspect-ratio: 4/3;
            background: var(--dark-lighter);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .gallery-item:hover {
            transform: scale(1.05);
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--dark);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 175, 55, 0.5);
        }
        
        /* Loading Animation */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }
        
        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-logo {
            font-family: 'Playfair Display', serif;
            font-size: 48px;
            color: var(--gold);
            letter-spacing: 4px;
            margin-bottom: 24px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading-bar {
            width: 200px;
            height: 2px;
            background: rgba(212, 175, 55, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .loading-progress {
            height: 100%;
            background: var(--gold);
            width: 0%;
            animation: load 1.5s ease forwards;
        }
        
        @keyframes load {
            to { width: 100%; }
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 4000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .toast {
            background: var(--dark-card);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideInRight 0.3s ease;
            min-width: 300px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast.info { border-left: 3px solid var(--info); }
        
        /* Responsive */
        @media (max-width: 1400px) {
            .app-container {
                grid-template-columns: 260px 1fr 360px;
            }
        }
        
        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 240px 1fr 320px;
            }
            .details-panel {
                display: none;
            }
            .app-container {
                grid-template-areas: 
                    "sidebar header header"
                    "sidebar map map";
            }
        }
        
        /* Marker Styles */
        .custom-marker {
            background: var(--gold);
            border: 3px solid var(--white);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .custom-marker:hover {
            transform: scale(1.2);
        }
        
        .marker-pulse {
            animation: markerPulse 2s infinite;
        }
        
        @keyframes markerPulse {
            0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(212, 175, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }
        
        /* Status Select in Detail */
        .status-select {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            background: var(--dark-lighter);
            color: var(--white);
            font-size: 13px;
            cursor: pointer;
            outline: none;
        }
        
        .video-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: rgba(212, 175, 55, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="loading-logo">VILLA TOWN</div>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
    </div>

    <!-- Auth Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <div class="auth-logo">
                <h1>VILLA TOWN</h1>
                <p>Элитная недвижимость Астаны</p>
            </div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Вход</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Регистрация</button>
            </div>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="admin@villatown.kz" required>
                </div>
                <div class="input-group">
                    <label>Пароль</label>
                    <input type="password" id="loginPassword" placeholder="••••••••" required>
                </div>
                <button type="submit" class="btn-primary">Войти в систему</button>
            </form>
            
            <form id="registerForm" style="display: none;" onsubmit="handleRegister(event)">
                <div class="input-group">
                    <label>Имя</label>
                    <input type="text" id="regName" placeholder="Александр" required>
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="regEmail" placeholder="agent@villatown.kz" required>
                </div>
                <div class="input-group">
                    <label>Пароль</label>
                    <input type="password" id="regPassword" placeholder="Минимум 8 символов" required>
                </div>
                <div class="input-group">
                    <label>Код доступа</label>
                    <input type="text" id="regCode" placeholder="Код от администратора" required>
                </div>
                <button type="submit" class="btn-primary">Создать аккаунт</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-value" id="totalObjects">24</div>
                    <div class="stat-label">Объектов</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeDeals">8</div>
                    <div class="stat-label">Сделок</div>
                </div>
            </div>
            
            <div class="nav-section">
                <div class="nav-title">Навигация</div>
                <div class="nav-item active" onclick="filterObjects('all')">
                    <i data-lucide="layout-grid"></i>
                    <span>Все объекты</span>
                </div>
                <div class="nav-item" onclick="filterObjects('sale')">
                    <i data-lucide="tag"></i>
                    <span>На продажу</span>
                </div>
                <div class="nav-item" onclick="filterObjects('rent')">
                    <i data-lucide="key"></i>
                    <span>Аренда</span>
                </div>
                <div class="nav-item" onclick="filterObjects('viewing')">
                    <i data-lucide="eye"></i>
                    <span>Просмотры</span>
                </div>
                <div class="nav-item" onclick="filterObjects('sold')">
                    <i data-lucide="check-circle"></i>
                    <span>Проданные</span>
                </div>
            </div>
            
            <div class="nav-section agents-list">
                <div class="nav-title">Агенты</div>
                <div id="agentsList">
                    <!-- Generated by JS -->
                </div>
            </div>
            
            <div style="margin-top: auto; padding-top: 24px; border-top: 1px solid rgba(212, 175, 55, 0.1);">
                <div class="nav-item" onclick="logout()">
                    <i data-lucide="log-out"></i>
                    <span>Выйти</span>
                </div>
            </div>
        </aside>

        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="brand">VILLA TOWN</div>
                <div class="search-box">
                    <i data-lucide="search"></i>
                    <input type="text" placeholder="Поиск по объектам, адресам, ID..." id="searchInput" oninput="handleSearch(this.value)">
                </div>
            </div>
            <div class="header-right">
                <button class="map-btn" onclick="openAddModal()" title="Добавить объект">
                    <i data-lucide="plus"></i>
                </button>
                <button class="map-btn" onclick="refreshData()" title="Обновить">
                    <i data-lucide="refresh-cw"></i>
                </button>
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">АД</div>
                    <span id="userName">Админ</span>
                    <i data-lucide="chevron-down" style="width: 16px; height: 16px;"></i>
                </div>
            </div>
        </header>

        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            
            <div class="map-controls">
                <button class="map-btn" onclick="map.zoomIn()">
                    <i data-lucide="plus"></i>
                </button>
                <button class="map-btn" onclick="map.zoomOut()">
                    <i data-lucide="minus"></i>
                </button>
                <button class="map-btn" onclick="resetMap()">
                    <i data-lucide="maximize"></i>
                </button>
            </div>
            
            <div class="filter-panel">
                <div class="filter-group">
                    <span class="filter-label">Тип сделки</span>
                    <select class="filter-select" id="dealTypeFilter" onchange="applyFilters()">
                        <option value="all">Все типы</option>
                        <option value="sale">Продажа</option>
                        <option value="rent">Аренда</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Тип недвижимости</span>
                    <select class="filter-select" id="propertyTypeFilter" onchange="applyFilters()">
                        <option value="all">Все</option>
                        <option value="apartment">Квартиры</option>
                        <option value="house">Дома</option>
                        <option value="penthouse">Пентхаусы</option>
                        <option value="villa">Виллы</option>
                        <option value="commercial">Коммерция</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Цена</span>
                    <div class="price-range">
                        <input type="number" class="price-input" placeholder="от" id="priceFrom" onchange="applyFilters()">
                        <span style="color: var(--gray);">—</span>
                        <input type="number" class="price-input" placeholder="до" id="priceTo" onchange="applyFilters()">
                    </div>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Район</span>
                    <select class="filter-select" id="districtFilter" onchange="applyFilters()">
                        <option value="all">Все районы</option>
                        <option value="esil">Есиль</option>
                        <option value="nura">Нура</option>
                        <option value="saryarka">Сарыарка</option>
                        <option value="almaty">Алматы</option>
                        <option value="baykonyr">Байконур</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Details Panel -->
        <aside class="details-panel">
            <div class="panel-header">
                <h2 class="panel-title">Объекты</h2>
                <button class="btn-add" onclick="openAddModal()">
                    <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                    Добавить
                </button>
            </div>
            <div class="objects-list" id="objectsList">
                <!-- Generated by JS -->
            </div>
        </aside>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal-overlay" id="objectModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Новый объект</h2>
                <button class="modal-close" onclick="closeModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form onsubmit="saveObject(event)">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">Название объекта</label>
                            <input type="text" class="form-input" id="objTitle" placeholder="Например: Пентхаус в Esil Tower" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Тип сделки</label>
                            <select class="form-select" id="objDealType" required>
                                <option value="sale">Продажа</option>
                                <option value="rent">Аренда</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Тип недвижимости</label>
                            <select class="form-select" id="objPropertyType" required>
                                <option value="apartment">Квартира</option>
                                <option value="house">Дом</option>
                                <option value="penthouse">Пентхаус</option>
                                <option value="villa">Вилла</option>
                                <option value="commercial">Коммерческая</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Цена (тенге)</label>
                            <input type="number" class="form-input" id="objPrice" placeholder="450000000" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Площадь (м²)</label>
                            <input type="number" class="form-input" id="objArea" placeholder="180" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Комнат</label>
                            <input type="number" class="form-input" id="objRooms" placeholder="4" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Этаж</label>
                            <input type="text" class="form-input" id="objFloor" placeholder="15/25">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Адрес</label>
                            <input type="text" class="form-input" id="objAddress" placeholder="пр. Кабанбай Батыра, 7" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Широта</label>
                            <input type="number" step="any" class="form-input" id="objLat" placeholder="51.1605" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Долгота</label>
                            <input type="number" step="any" class="form-input" id="objLng" placeholder="71.4704" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ответственный агент</label>
                            <select class="form-select" id="objAgent" required>
                                <!-- Generated by JS -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Статус</label>
                            <select class="form-select" id="objStatus" required>
                                <option value="active">Активен</option>
                                <option value="viewing">На просмотре</option>
                                <option value="negotiation">Переговоры</option>
                                <option value="sold">Продан</option>
                                <option value="rented">Сдан</option>
                                <option value="archived">В архиве</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Описание</label>
                            <textarea class="form-textarea" id="objDescription" placeholder="Подробное описание объекта, особенности, преимущества..."></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Фотографии</label>
                            <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                                <i data-lucide="image-plus"></i>
                                <div style="color: var(--gray); font-size: 14px;">Нажмите для загрузки или перетащите фото</div>
                                <div style="color: var(--gray); font-size: 12px; margin-top: 4px;">До 20 фотографий</div>
                                <input type="file" id="photoInput" multiple accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                            </div>
                            <div id="photoPreview" style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Отмена</button>
                    <button type="submit" class="btn-primary" style="width: auto; padding: 12px 32px;">Сохранить объект</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Object Detail View -->
    <div class="detail-view" id="detailView">
        <!-- Generated by JS -->
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // State
        let currentUser = null;
        let map = null;
        let markers = [];
        let objects = [];
        let agents = [];
        let currentFilter = 'all';
        let editingObjectId = null;
        
        // Sample Data
        const sampleAgents = [
            { id: 1, name: 'Айдар Нурланов', initials: 'АН', objects: 5, color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
            { id: 2, name: 'Динара Смагулова', initials: 'ДС', objects: 4, color: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
            { id: 3, name: 'Серик Байтасов', initials: 'СБ', objects: 6, color: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
            { id: 4, name: 'Алия Темирханова', initials: 'АТ', objects: 3, color: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)' },
            { id: 5, name: 'Марат Ибрагимов', initials: 'МИ', objects: 4, color: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' },
            { id: 6, name: 'Гульмира Оспанова', initials: 'ГО', objects: 2, color: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)' }
        ];
        
        const sampleObjects = [
            {
                id: 1,
                title: 'Пентхаус в Esil Tower',
                dealType: 'sale',
                propertyType: 'penthouse',
                price: 450000000,
                area: 320,
                rooms: 5,
                floor: '45/50',
                address: 'пр. Кабанбай Батыра, 7',
                lat: 51.1605,
                lng: 71.4704,
                agentId: 1,
                status: 'active',
                description: 'Элитный пентхаус с панорамным видом на реку Есиль. Авторский ремонт, итальянская мебель, система умный дом.',
                photos: ['https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?w=800'],
                views: 12,
                created: '2024-01-15'
            },
            {
                id: 2,
                title: 'Вилла в премиум-квартале',
                dealType: 'sale',
                propertyType: 'villa',
                price: 850000000,
                area: 450,
                rooms: 6,
                floor: '2',
                address: 'ул. Курмангазы, район Нура',
                lat: 51.1258,
                lng: 71.4706,
                agentId: 2,
                status: 'viewing',
                description: 'Закрытый коттеджный городок. Бассейн, сауна, кинозал, охрана 24/7.',
                photos: ['https://images.unsplash.com/photo-1613490493576-7fde63acd811?w=800'],
                views: 8,
                created: '2024-01-20'
            },
            {
                id: 3,
                title: 'Апартаменты бизнес-класса',
                dealType: 'rent',
                propertyType: 'apartment',
                price: 800000,
                area: 95,
                rooms: 3,
                floor: '12/20',
                address: 'пр. Мангилик Ел, 55',
                lat: 51.1284,
                lng: 71.4306,
                agentId: 3,
                status: 'active',
                description: 'Сдается на длительный срок. Евроремонт, вся техника, рядом метро.',
                photos: ['https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=800'],
                views: 25,
                created: '2024-02-01'
            },
            {
                id: 4,
                title: 'Офисное помещение',
                dealType: 'sale',
                propertyType: 'commercial',
                price: 120000000,
                area: 180,
                rooms: 4,
                floor: '3/12',
                address: 'пр. Назарбаева, 100',
                lat: 51.1445,
                lng: 71.4456,
                agentId: 4,
                status: 'negotiation',
                description: 'Готовый бизнес-центр. Парковка, ресепшн, охрана.',
                photos: ['https://images.unsplash.com/photo-1497366216548-37526070297c?w=800'],
                views: 6,
                created: '2024-02-05'
            },
            {
                id: 5,
                title: 'Таунхаус Family Village',
                dealType: 'sale',
                propertyType: 'house',
                price: 380000000,
                area: 280,
                rooms: 4,
                floor: '3',
                address: 'пос. Коктал, ул. Лесная',
                lat: 51.0892,
                lng: 71.4023,
                agentId: 5,
                status: 'active',
                description: 'Современный таунхаус для семьи. Двор, гараж на 2 машины, детская площадка.',
                photos: ['https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=800'],
                views: 15,
                created: '2024-02-10'
            },
            {
                id: 6,
                title: 'Loft в центре',
                dealType: 'rent',
                propertyType: 'apartment',
                price: 1200000,
                area: 110,
                rooms: 2,
                floor: '5/8',
                address: 'ул. Кунаева, 12',
                lat: 51.1669,
                lng: 71.4261,
                agentId: 6,
                status: 'rented',
                description: 'Стильный лофт с высокими потолками. Идеально для фотостудии или жилья.',
                photos: ['https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=800'],
                views: 30,
                created: '2024-01-05'
            }
        ];

        // Initialize
        window.onload = function() {
            setTimeout(() => {
                document.getElementById('loading').classList.add('hidden');
                lucide.createIcons();
            }, 1500);
            
            // Check for saved session
            const savedUser = localStorage.getItem('villaTownUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showApp();
            }
            
            agents = sampleAgents;
            objects = sampleObjects;
        };

        // Auth Functions
        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'login') {
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('registerForm').style.display = 'none';
            } else {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'block';
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Demo validation
            if (email && password) {
                currentUser = {
                    email: email,
                    name: email.includes('admin') ? 'Администратор' : 'Агент',
                    initials: email.includes('admin') ? 'АД' : 'АГ'
                };
                localStorage.setItem('villaTownUser', JSON.stringify(currentUser));
                showToast('Добро пожаловать в Villa Town CRM!', 'success');
                showApp();
            }
        }

        function handleRegister(e) {
            e.preventDefault();
            showToast('Регистрация успешна! Ожидайте подтверждения администратора.', 'success');
            switchAuthTab('login');
        }

        function logout() {
            localStorage.removeItem('villaTownUser');
            currentUser = null;
            location.reload();
        }

        function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'grid';
            
            // Update user info
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAvatar').textContent = currentUser.initials;
            
            initMap();
            renderAgents();
            renderObjects();
            updateStats();
            
            lucide.createIcons();
        }

        // Map Functions
        function initMap() {
            // Astana center coordinates
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([51.1605, 71.4704], 13);
            
            // Dark theme map tiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(map);
            
            updateMarkers();
        }

        function updateMarkers() {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            const filtered = getFilteredObjects();
            
            filtered.forEach(obj => {
                const marker = L.marker([obj.lat, obj.lng], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="custom-marker ${obj.status === 'viewing' ? 'marker-pulse' : ''}"></div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).addTo(map);
                
                marker.on('click', () => showObjectDetail(obj));
                markers.push(marker);
            });
        }

        function resetMap() {
            map.setView([51.1605, 71.4704], 13);
        }

        // Rendering Functions
        function renderAgents() {
            const container = document.getElementById('agentsList');
            container.innerHTML = agents.map(agent => `
                <div class="agent-item" onclick="filterByAgent(${agent.id})">
                    <div class="agent-avatar" style="background: ${agent.color}">${agent.initials}</div>
                    <div class="agent-info">
                        <div class="agent-name">${agent.name}</div>
                        <div class="agent-objects">${agent.objects} объектов</div>
                    </div>
                    <div class="status-dot"></div>
                </div>
            `).join('');
        }

        function renderObjects() {
            const container = document.getElementById('objectsList');
            const filtered = getFilteredObjects();
            
            container.innerHTML = filtered.map(obj => {
                const agent = agents.find(a => a.id === obj.agentId);
                const statusClass = obj.status === 'active' ? 'sale' : 
                                   obj.status === 'rented' ? 'rent' :
                                   obj.status === 'viewing' ? 'viewing' : 'sold';
                const statusText = {
                    'active': 'В продаже',
                    'rent': 'Аренда',
                    'viewing': 'На просмотре',
                    'sold': 'Продано',
                    'rented': 'Сдано',
                    'negotiation': 'Переговоры',
                    'archived': 'Архив'
                }[obj.status] || obj.status;
                
                return `
                    <div class="object-card" onclick="showObjectDetail(${obj.id})">
                        <div class="object-image">
                            <img src="${obj.photos[0] || 'https://via.placeholder.com/400x300?text=No+Photo'}" alt="${obj.title}">
                            <div class="object-badge badge-${statusClass}">${statusText}</div>
                            <div class="object-price">${formatPrice(obj.price)}</div>
                            ${obj.video ? '<div class="video-badge"><i data-lucide="play" style="width: 16px; height: 16px;"></i></div>' : ''}
                        </div>
                        <div class="object-info">
                            <div class="object-title">${obj.title}</div>
                            <div class="object-meta">
                                <span><i data-lucide="maximize" style="width: 14px; height: 14px;"></i> ${obj.area} м²</span>
                                <span><i data-lucide="bed-double" style="width: 14px; height: 14px;"></i> ${obj.rooms} комн.</span>
                                <span><i data-lucide="building" style="width: 14px; height: 14px;"></i> ${obj.floor}</span>
                            </div>
                            <div class="object-footer">
                                <div class="object-agent">
                                    <div class="agent-mini" style="background: ${agent ? agent.color : 'var(--gold)'}">${agent ? agent.initials : '??'}</div>
                                    <span>${agent ? agent.name.split(' ')[0] : 'Не назначен'}</span>
                                </div>
                                <div class="object-actions" onclick="event.stopPropagation()">
                                    <button class="action-btn" onclick="editObject(${obj.id})">
                                        <i data-lucide="edit-2" style="width: 14px; height: 14px;"></i>
                                    </button>
                                    <button class="action-btn" onclick="deleteObject(${obj.id})">
                                        <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
            updateMarkers();
        }

        function getFilteredObjects() {
            let filtered = objects;
            
            // Filter by type
            if (currentFilter !== 'all') {
                if (['sale', 'rent'].includes(currentFilter)) {
                    filtered = filtered.filter(o => o.dealType === currentFilter);
                } else if (currentFilter === 'viewing') {
                    filtered = filtered.filter(o => o.status === 'viewing');
                } else if (currentFilter === 'sold') {
                    filtered = filtered.filter(o => ['sold', 'rented', 'archived'].includes(o.status));
                } else if (!isNaN(currentFilter)) {
                    // Filter by agent ID
                    filtered = filtered.filter(o => o.agentId === parseInt(currentFilter));
                }
            }
            
            // Filter by search
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(o => 
                    o.title.toLowerCase().includes(searchTerm) ||
                    o.address.toLowerCase().includes(searchTerm) ||
                    o.id.toString().includes(searchTerm)
                );
            }
            
            // Filter by deal type select
            const dealType = document.getElementById('dealTypeFilter').value;
            if (dealType !== 'all') {
                filtered = filtered.filter(o => o.dealType === dealType);
            }
            
            // Filter by property type
            const propType = document.getElementById('propertyTypeFilter').value;
            if (propType !== 'all') {
                filtered = filtered.filter(o => o.propertyType === propType);
            }
            
            // Filter by price
            const priceFrom = parseInt(document.getElementById('priceFrom').value) || 0;
            const priceTo = parseInt(document.getElementById('priceTo').value) || Infinity;
            filtered = filtered.filter(o => o.price >= priceFrom && o.price <= priceTo);
            
            // Filter by district (simplified)
            const district = document.getElementById('districtFilter').value;
            if (district !== 'all') {
                // This would need proper district mapping in real app
                filtered = filtered.filter(o => o.address.toLowerCase().includes(district));
            }
            
            return filtered;
        }

        // Filter Functions
        function filterObjects(type) {
            currentFilter = type;
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            renderObjects();
        }

        function filterByAgent(agentId) {
            currentFilter = agentId.toString();
            renderObjects();
            showToast(`Фильтр по агенту: ${agents.find(a => a.id === agentId).name}`, 'info');
        }

        function applyFilters() {
            renderObjects();
        }

        function handleSearch(value) {
            renderObjects();
        }

        // Object Management
        function openAddModal() {
            editingObjectId = null;
            document.getElementById('modalTitle').textContent = 'Новый объект';
            document.getElementById('objectModal').classList.add('active');
            renderAgentSelect();
        }

        function editObject(id) {
            const obj = objects.find(o => o.id === id);
            if (!obj) return;
            
            editingObjectId = id;
            document.getElementById('modalTitle').textContent = 'Редактировать объект';
            
            // Fill form
            document.getElementById('objTitle').value = obj.title;
            document.getElementById('objDealType').value = obj.dealType;
            document.getElementById('objPropertyType').value = obj.propertyType;
            document.getElementById('objPrice').value = obj.price;
            document.getElementById('objArea').value = obj.area;
            document.getElementById('objRooms').value = obj.rooms;
            document.getElementById('objFloor').value = obj.floor;
            document.getElementById('objAddress').value = obj.address;
            document.getElementById('objLat').value = obj.lat;
            document.getElementById('objLng').value = obj.lng;
            document.getElementById('objStatus').value = obj.status;
            document.getElementById('objDescription').value = obj.description || '';
            
            renderAgentSelect(obj.agentId);
            document.getElementById('objectModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('objectModal').classList.remove('active');
            document.querySelector('form').reset();
            document.getElementById('photoPreview').innerHTML = '';
        }

        function renderAgentSelect(selectedId) {
            const select = document.getElementById('objAgent');
            select.innerHTML = agents.map(a => 
                `<option value="${a.id}" ${a.id === selectedId ? 'selected' : ''}>${a.name}</option>`
            ).join('');
        }

        function saveObject(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('objTitle').value,
                dealType: document.getElementById('objDealType').value,
                propertyType: document.getElementById('objPropertyType').value,
                price: parseInt(document.getElementById('objPrice').value),
                area: parseInt(document.getElementById('objArea').value),
                rooms: parseInt(document.getElementById('objRooms').value),
                floor: document.getElementById('objFloor').value,
                address: document.getElementById('objAddress').value,
                lat: parseFloat(document.getElementById('objLat').value),
                lng: parseFloat(document.getElementById('objLng').value),
                agentId: parseInt(document.getElementById('objAgent').value),
                status: document.getElementById('objStatus').value,
                description: document.getElementById('objDescription').value,
                photos: ['https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=800']
            };
            
            if (editingObjectId) {
                const index = objects.findIndex(o => o.id === editingObjectId);
                objects[index] = { ...objects[index], ...formData };
                showToast('Объект успешно обновлен', 'success');
            } else {
                const newId = Math.max(...objects.map(o => o.id)) + 1;
                objects.push({ ...formData, id: newId, views: 0, created: new Date().toISOString().split('T')[0] });
                showToast('Новый объект добавлен', 'success');
            }
            
            closeModal();
            renderObjects();
            updateStats();
        }

        function deleteObject(id) {
            if (!confirm('Вы уверены, что хотите удалить этот объект?')) return;
            objects = objects.filter(o => o.id !== id);
            renderObjects();
            updateStats();
            showToast('Объект удален', 'info');
        }

        function showObjectDetail(objOrId) {
            let obj;
            if (typeof objOrId === 'number') {
                obj = objects.find(o => o.id === objOrId);
            } else {
                obj = objOrId;
            }
            if (!obj) return;
            
            const agent = agents.find(a => a.id === obj.agentId);
            const detailView = document.getElementById('detailView');
            
            const statusOptions = {
                'active': 'Активен',
                'viewing': 'На просмотре',
                'negotiation': 'Переговоры',
                'sold': 'Продан',
                'rented': 'Сдан',
                'archived': 'В архиве'
            };
            
            detailView.innerHTML = `
                <div class="detail-header">
                    <img src="${obj.photos[0]}" alt="${obj.title}">
                    <button class="detail-close" onclick="closeDetail()">
                        <i data-lucide="x"></i>
                    </button>
                    <div class="detail-header-overlay">
                        <div class="detail-price">${formatPrice(obj.price)}</div>
                        <h1 class="detail-title">${obj.title}</h1>
                    </div>
                </div>
                <div class="detail-content">
                    <div class="detail-section">
                        <div class="detail-section-title">Характеристики</div>
                        <div class="detail-features">
                            <div class="feature-item">
                                <i data-lucide="maximize" class="feature-icon"></i>
                                <div class="feature-value">${obj.area}</div>
                                <div class="feature-label">м² площадь</div>
                            </div>
                            <div class="feature-item">
                                <i data-lucide="bed-double" class="feature-icon"></i>
                                <div class="feature-value">${obj.rooms}</div>
                                <div class="feature-label">комнат</div>
                            </div>
                            <div class="feature-item">
                                <i data-lucide="building" class="feature-icon"></i>
                                <div class="feature-value">${obj.floor}</div>
                                <div class="feature-label">этаж</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">Адрес</div>
                        <p style="color: var(--gray); line-height: 1.6;">${obj.address}</p>
                        <div style="margin-top: 12px; color: var(--gold); font-size: 14px;">
                            <i data-lucide="map-pin" style="width: 14px; height: 14px; display: inline; vertical-align: middle;"></i>
                            ${obj.lat.toFixed(4)}, ${obj.lng.toFixed(4)}
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">Описание</div>
                        <p style="color: var(--gray); line-height: 1.8;">${obj.description || 'Описание отсутствует'}</p>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">Ответственный агент</div>
                        <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--dark-lighter); border-radius: 12px;">
                            <div style="width: 48px; height: 48px; border-radius: 50%; background: ${agent ? agent.color : 'var(--gold)'}; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white;">
                                ${agent ? agent.initials : '??'}
                            </div>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">${agent ? agent.name : 'Не назначен'}</div>
                                <div style="font-size: 13px; color: var(--gray);">+7 (7172) 57-66-66</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">Статус сделки</div>
                        <select class="status-select" onchange="updateObjectStatus(${obj.id}, this.value)">
                            ${Object.entries(statusOptions).map(([key, label]) => 
                                `<option value="${key}" ${obj.status === key ? 'selected' : ''}>${label}</option>`
                            ).join('')}
                        </select>
                        
                        <div class="status-timeline">
                            <div class="timeline-item ${obj.status === 'active' ? 'active' : ''}">
                                <div class="timeline-dot"></div>
                                <div style="font-size: 12px; color: var(--gray);">Активен</div>
                            </div>
                            <div class="timeline-item ${obj.status === 'viewing' ? 'active' : ''}">
                                <div class="timeline-dot"></div>
                                <div style="font-size: 12px; color: var(--gray);">Просмотр</div>
                            </div>
                            <div class="timeline-item ${obj.status === 'negotiation' ? 'active' : ''}">
                                <div class="timeline-dot"></div>
                                <div style="font-size: 12px; color: var(--gray);">Переговоры</div>
                            </div>
                            <div class="timeline-item ${['sold', 'rented'].includes(obj.status) ? 'active' : ''}">
                                <div class="timeline-dot"></div>
                                <div style="font-size: 12px; color: var(--gray);">Сделка</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">Галерея</div>
                        <div class="gallery-grid">
                            ${obj.photos.map((photo, idx) => `
                                <div class="gallery-item">
                                    <img src="${photo}" alt="Фото ${idx + 1}">
                                </div>
                            `).join('')}
                            <div class="gallery-item" style="border: 2px dashed rgba(212, 175, 55, 0.3); display: flex; align-items: center; justify-content: center; color: var(--gold);">
                                <i data-lucide="plus" style="width: 24px; height: 24px;"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button class="btn-primary" style="flex: 1;" onclick="editObject(${obj.id})">
                            <i data-lucide="edit-2" style="width: 16px; height: 16px; display: inline; vertical-align: middle; margin-right: 8px;"></i>
                            Редактировать
                        </button>
                        <button class="btn-secondary" style="flex: 1;" onclick="deleteObject(${obj.id})">
                            <i data-lucide="trash-2" style="width: 16px; height: 16px; display: inline; vertical-align: middle; margin-right: 8px;"></i>
                            Удалить
                        </button>
                    </div>
                </div>
            `;
            
            detailView.style.display = 'block';
            lucide.createIcons();
            
            // Center map on object
            map.setView([obj.lat, obj.lng], 16);
        }

        function closeDetail() {
            document.getElementById('detailView').style.display = 'none';
        }

        function updateObjectStatus(id, newStatus) {
            const obj = objects.find(o => o.id === id);
            if (obj) {
                obj.status = newStatus;
                renderObjects();
                showToast('Статус обновлен', 'success');
            }
        }

        // Utilities
        function formatPrice(price) {
            if (price >= 1000000000) {
                return (price / 1000000000).toFixed(1) + ' млрд ₸';
            } else if (price >= 1000000) {
                return (price / 1000000).toFixed(0) + ' млн ₸';
            } else if (price >= 1000) {
                return (price / 1000).toFixed(0) + ' тыс ₸';
            }
            return price + ' ₸';
        }

        function updateStats() {
            document.getElementById('totalObjects').textContent = objects.length;
            document.getElementById('activeDeals').textContent = objects.filter(o => ['viewing', 'negotiation'].includes(o.status)).length;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info';
            
            toast.innerHTML = `
                <i data-lucide="${icon}" style="width: 20px; height: 20px; color: var(--${type === 'info' ? 'gold' : type});"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function handlePhotoUpload(e) {
            const files = e.target.files;
            const preview = document.getElementById('photoPreview');
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const div = document.createElement('div');
                    div.style.cssText = 'width: 80px; height: 80px; border-radius: 8px; overflow: hidden; position: relative;';
                    div.innerHTML = `
                        <img src="${event.target.result}" style="width: 100%; height: 100%; object-fit: cover;">
                        <button onclick="this.parentElement.remove()" style="position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; background: rgba(0,0,0,0.7); border: none; border-radius: 50%; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px;">×</button>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function refreshData() {
            showToast('Данные обновлены', 'success');
            renderObjects();
            updateMarkers();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeDetail();
            }
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                openAddModal();
            }
        });
    </script>
</body>
</html>
